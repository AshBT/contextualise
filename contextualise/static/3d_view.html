<!DOCTYPE HTML>
<html>

<head>
	<style>
	body {
        margin: 0;
        overflow: hidden;
    }
	</style>
	<title>3D Scene Viewer | Contextualise</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta charset="UTF-8" />
	<script src="three.js/build/three.min.js"></script>
	<script src="three.js/examples/js/loaders/GLTFLoader.js"></script>
	<script src="three.js/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
	<canvas id="contextualise-canvas"></canvas>
	<script>
		'use strict';

		function getUrlParams(url) {
			var params = {};
			(url + '?').split('?')[1].split('&').forEach(function (pair) {
				pair = (pair + '=').split('=').map(decodeURIComponent);
				if (pair[0].length) {
					params[pair[0]] = pair[1];
				}
			});
			return params;
		}

		var mapIdentifier = getUrlParams(window.location)['map_identifier'];
		var topicIdentifier = getUrlParams(window.location)['topic_identifier'];
		var fileIdentifier = getUrlParams(window.location)['file_identifier'];

		// SETUP
		window.addEventListener('resize', onWindowResize, false);

		// RENDERER
		var renderer = new THREE.WebGLRenderer({
        canvas: document.getElementById('contextualise-canvas'),
            antialias: true,
            alpha: true
        });
        renderer.setPixelRatio((window.devicePixelRatio) ? window.devicePixelRatio : 1);
        renderer.autoClear = false;
        renderer.setClearColor(0x000000, 0.0);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // PCFShadowMap
		renderer.setSize(window.innerWidth, window.innerHeight);

		// SCENE
		var scene = new THREE.Scene();
		scene.background = new THREE.Color(0xffffff);

		// CAMERA
		var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000);
		camera.position.set(45, 45, 45);
		camera.lookAt(new THREE.Vector3());
		scene.add(camera);

		// CONTROLS
		var controls = new THREE.OrbitControls(camera, renderer.domElement);
		controls.enableDamping = true;
		controls.dampingFactor = 0.75;
		controls.screenSpacePanning = false;
		controls.minDistance = 1;
		controls.maxDistance = 50;
		controls.maxPolarAngle = Math.PI / 2;

		// LIGHTS
		var light1 = new THREE.PointLight(0xffffff, 2.5, 0, 2);
        light1.position.set(80, 80, 80);
        scene.add(light1); // See URL: https://stackoverflow.com/questions/20469637/three-js-no-update-of-scene-lighting-when-light-moving

        light1.castShadow = true;
        light1.shadow.mapSize.width = 1024;
        light1.shadow.mapSize.height = 1024;
        light1.shadow.camera.near = 0.5;
        light1.shadow.camera.far = 500;
        light1.shadow.bias = -0.0015;

        var light2 = new THREE.AmbientLight(0x404040, 1); // Soft white light
        scene.add(light2);

		// MODELS AND LOADER
		var loader = new THREE.GLTFLoader();
		var gltfUrl = "./resources/" + mapIdentifier + "/" + topicIdentifier + "/" + fileIdentifier;

		loader.load(gltfUrl, function (gltf) {
		    /*
		    gltf.scenes[0].traverse(function (child) {
                if (child.material && child.material.map) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
            */
			scene.add(gltf.scene);
		});

		// RENDER LOOP
		animate();

		function animate() {
			controls.update(); // Only required if controls.enableDamping = true, or if controls.autoRotate = true.

			renderer.render(scene, camera);
			requestAnimationFrame(animate);
		}

		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		}
	</script>
</body>

</html>